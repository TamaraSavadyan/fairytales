# Story Module для Yii 2

Модуль для Yii 2 приложения, который служит прокси к Python API сервису генерации сказок. Модуль предоставляет удобную форму для пользователей и поддерживает потоковый вывод результата.

## Установка и настройка

### 1. Копирование модуля

Скопируйте папку `yii-module` в `modules/story` вашего Yii 2 приложения:

```bash
cp -r yii-module /path/to/your/yii2-app/modules/story
```

Или создайте символическую ссылку:

```bash
ln -s /path/to/yii-module /path/to/your/yii2-app/modules/story
```

### 2. Регистрация модуля

Добавьте модуль в конфигурацию приложения. Откройте `config/web.php` (или `config/main.php`) и добавьте модуль:

```php
'modules' => [
    'story' => [
        'class' => 'app\modules\story\StoryModule',
        'pythonApiUrl' => 'http://localhost:8000', // URL вашего Python API
        'timeout' => 300, // Таймаут в секундах
    ],
    // ... другие модули
],
```

### 3. Настройка URL правил

Добавьте правила маршрутизации в `config/web.php` в секцию `urlManager`:

```php
'urlManager' => [
    'enablePrettyUrl' => true,
    'showScriptName' => false,
    'rules' => [
        'story' => 'story/default/index',
        'story/result' => 'story/default/result',
        'story/stream' => 'story/default/stream',
        // ... другие правила
    ],
],
```

Или используйте стандартные правила модуля (модуль будет доступен по `/story`).

### 4. Зависимости

Модуль требует:
- Yii 2 Framework
- PHP 7.0 или выше
- Расширение cURL (для запросов к Python API)
- Активный Python API сервис (см. документацию `python-api/README.md`)

## Использование

### Доступ к модулю

После установки модуль будет доступен по адресу:

```
http://your-domain.com/story
```

### Форма генерации

1. Пользователь открывает форму на `/story`
2. Заполняет поля:
   - **Возраст** (от 1 до 18 лет)
   - **Язык** (Русский или Казахский)
   - **Персонажи** (мультивыбор чекбоксами, зависит от выбранного языка)
3. Нажимает "Сгенерировать сказку"

### Результат

После отправки формы:
1. Пользователь перенаправляется на страницу результата
2. Начинается потоковая загрузка сказки из Python API
3. Текст отображается по мере поступления данных
4. Markdown автоматически преобразуется в HTML для красивого отображения

## Конфигурация

### Параметры модуля

В конфигурации приложения можно указать следующие параметры:

```php
'story' => [
    'class' => 'app\modules\story\StoryModule',
    'pythonApiUrl' => 'http://localhost:8000', // Обязательно: URL Python API
    'timeout' => 300, // Опционально: таймаут запросов (по умолчанию 300 секунд)
],
```

### Настройка Python API URL

Если ваш Python API работает на другом хосте или порту, измените параметр `pythonApiUrl`:

```php
'pythonApiUrl' => 'http://python-api.example.com:8000',
```

Для продакшена рекомендуется использовать HTTPS:

```php
'pythonApiUrl' => 'https://api.example.com',
```

## Структура модуля

```
modules/story/
├── StoryModule.php          # Основной класс модуля
├── controllers/
│   └── DefaultController.php # Контроллер с действиями
├── models/
│   └── StoryForm.php        # Модель формы валидации
├── views/
│   └── default/
│       ├── index.php        # Форма генерации
│       └── result.php       # Страница результата
└── README.md               # Документация
```

## API Endpoints модуля

### `GET /story` или `story/default/index`

Отображает форму для генерации сказки.

### `GET /story/result` или `story/default/result`

Отображает страницу результата с потоковой загрузкой сказки.

**Параметры:**
- `age` (int) - Возраст ребёнка
- `language` (string) - Язык ('ru' или 'kk')
- `characters[]` (array) - Массив персонажей

### `GET /story/stream` или `story/default/stream`

Проксирует запрос к Python API и возвращает потоковый ответ.

**Параметры:** (те же, что и для `/result`)

**Ответ:** Потоковый Markdown текст

## Обработка ошибок

Модуль обрабатывает следующие ошибки:

1. **Некорректные входные данные** - валидация формы и отображение ошибок
2. **Недоступность Python API** - показ понятного сообщения об ошибке пользователю
3. **Таймаут запроса** - настраивается через параметр `timeout`

## Персонажи

Модуль предоставляет предустановленный список персонажей для каждого языка:

### Русский язык:
- Колобок
- Медведь
- Заяц
- Волк
- Лиса

### Казахский язык:
- Алдар Көсе
- Әйел Арстан
- Қыдыр
- Жез Тікен
- Түлкі

Чтобы изменить список персонажей, отредактируйте метод `getAvailableCharacters()` в `models/StoryForm.php`.

## Кастомизация

### Изменение внешнего вида

Отредактируйте файлы в `views/default/` для изменения HTML и стилей.

### Изменение логики валидации

Измените правила валидации в `models/StoryForm.php` метод `rules()`.

### Добавление функций

Вы можете расширить функциональность модуля, добавив:
- Кеширование сказок
- История запросов
- Сохранение в базу данных
- Выбор стиля сказки

## Примеры использования

### Прямой запрос к API через модуль

```php
use app\modules\story\models\StoryForm;

$model = new StoryForm();
$model->age = 6;
$model->language = 'kk';
$model->characters = ['Алдар Көсе', 'Әйел Арстан'];

if ($model->validate()) {
    // Перенаправление на генерацию
    return Yii::$app->response->redirect([
        '/story/result',
        'age' => $model->age,
        'language' => $model->language,
        'characters' => $model->characters,
    ]);
}
```

## Устранение неполадок

### Python API недоступен

Проверьте:
1. Запущен ли Python API сервис
2. Правильно ли указан `pythonApiUrl` в конфигурации
3. Доступен ли сервис из вашего Yii приложения (проверьте сетевые настройки, файрвол)

### Потоковая передача не работает

Убедитесь, что:
1. Включено расширение cURL в PHP
2. Не используется буферизация вывода на уровне веб-сервера
3. В браузере поддерживается Fetch API (современные браузеры)

### Ошибки валидации

Проверьте логи Yii для детальной информации об ошибках валидации.

## Лицензия

Этот модуль создан в рамках тестового задания.

